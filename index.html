<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Cartera</title>
    
    <!-- 1. Estilos (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React y ReactDOM (Producci贸n) -->
    <script crossorigin src="https://unpkg.com/react@18.3.1/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Librer铆as para Reportes (PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: .8; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* Scrollbar personalizada */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        body { font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- ICONOS INTEGRADOS (SVG Nativos) ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Icons = {
            AlertCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>,
            CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            Search: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></IconBase>,
            RefreshCw: (p) => <IconBase {...p}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconBase>,
            CreditCard: (p) => <IconBase {...p}><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>,
            XCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>,
            HelpCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>,
            BellRing: (p) => <IconBase {...p}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></IconBase>,
            Filter: (p) => <IconBase {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>,
            User: (p) => <IconBase {...p}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            TrendingDown: (p) => <IconBase {...p}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></IconBase>,
            DollarSign: (p) => <IconBase {...p}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>,
            X: (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>,
            Target: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>,
            Handshake: (p) => <IconBase {...p}><path d="m11 17 2 2a1 1 0 1 0 3-3"/><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-1.42-1.42l4.82-4.82a1 1 0 0 1 1.42 0l2.12 2.12a1 1 0 0 0 1.42 0l1.29-1.29a3 3 0 0 0 0-4.24l-2.12-2.12a3 3 0 0 0-4.24 0l-3.65 3.65a3 3 0 0 0 0 4.24l.88.88a1 1 0 0 1-1.42 1.42l-4.24-4.24a1 1 0 0 0-1.42 0l-2.12 2.12a3 3 0 0 0 0 4.24l2.12 2.12"/><path d="m7 13 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-1.42-1.42l4.82-4.82a1 1 0 0 1 1.42 0l2.12 2.12a1 1 0 0 0 1.42 0l1.29-1.29a3 3 0 0 0 0-4.24l-2.12-2.12a3 3 0 0 0-4.24 0l-3.65 3.65a3 3 0 0 0 0 4.24l.88.88a1 1 0 0 1-1.42 1.42l-4.24-4.24a1 1 0 0 0-1.42 0l-2.12 2.12a3 3 0 0 0 0 4.24l2.12 2.12"/></IconBase>,
            Smartphone: (p) => <IconBase {...p}><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></IconBase>,
            ShieldAlert: (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>,
            AlertTriangle: (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>,
            Phone: (p) => <IconBase {...p}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></IconBase>,
            MessageCircle: (p) => <IconBase {...p}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            Database: (p) => <IconBase {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconBase>,
            BarChart4: (p) => <IconBase {...p}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>,
            Edit2: (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>,
            ArrowLeft: (p) => <IconBase {...p}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconBase>
        };

        // --- CONFIGURACIN ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbz770i0j3vK5-9M2Z2EheDh9GX2x2j2KbjfFm_yNadBg5db3tEc5so58KWeIX5SwTmAZw/exec';
        const APP_VERSION = "v3.8.0 (Drill-down Vendedores)";

        const QUOTA_LABELS = {
            q1: { id: 'primera', label: 'Primera Cuota', weeksAgo: 3 },
            fpd3: { id: 'primera', label: 'FPD3 (Hace 2 Semanas)', weeksAgo: 2 },  
            fpd7: { id: 'primera', label: 'FPD7 (Hace 3 Semanas)', weeksAgo: 3 }, 
            fpd15: { id: 'primera', label: 'FPD15 (Hace 4 Semanas)', weeksAgo: 4 }  
        };

        // CONFIGURACIN DE CARTERAS
        const PORTFOLIO_CONFIG = {
            alocredit: {
                name: "ALOCREDIT",
                theme: "indigo",
                quotas: ['fpd3', 'fpd7', 'fpd15'], 
                columns: {
                    seller: ['responsable', 'vendedor', 'asesor'],
                    client: ['cliente', 'nombre', 'nombres', 'nombre cliente'], 
                    device: ['modelo - equipo', 'equipo', 'modelo'],
                    phone: ['celular', 'telefono', 'tel茅fono', 'movil', 'contacto'], 
                    date: ['fecha venta', 'fecha desembolso', 'fecha creacion', 'fecha'],
                    quotaDate: 'cuota',
                    paymentStatus: ['pagos'], 
                    comments: ['comentarios', 'observaciones', 'gestion'],
                    // NUEVOS CAMPOS PARA DETALLE
                    id: ['cedula', 'documento', 'cc', 'nit', 'id'],
                    email: ['email', 'correo', 'mail']
                }
            },
            payjoy: {
                name: "PAYJOY",
                theme: "blue",
                quotas: ['fpd3', 'fpd7', 'fpd15'], 
                columns: {
                    seller: ['vendedor', 'asesor', 'ejecutivo'],
                    client: ['cliente', 'nombre', 'nombres', 'nombre cliente'], 
                    device: ['equipo', 'modelo', 'celular'],
                    phone: ['celular', 'telefono', 'tel茅fono', 'movil', 'contacto'], 
                    date: ['fecha venta', 'fecha desembolso', 'fecha'],
                    quotaDate: 'cuota',
                    paymentStatus: ['pagos'], 
                    comments: ['comentarios', 'notas', 'gestion'],
                    id: ['cedula', 'documento', 'cc', 'nit', 'id'],
                    email: ['email', 'correo', 'mail']
                }
            }
        };

        // --- COMPONENTE LOGIN ---
        const Login = ({ onLogin }) => {
            const [user, setUser] = useState('');
            const [pass, setPass] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (user.toUpperCase() === 'ADMIN' && pass === 'Cescode1@') {
                    onLogin();
                } else {
                    setError('Credenciales incorrectas');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm border border-slate-200">
                        <div className="flex justify-center mb-6">
                            <div className="p-4 bg-indigo-50 rounded-full border border-indigo-100">
                                <Icons.Lock className="w-8 h-8 text-indigo-600" />
                            </div>
                        </div>
                        <h2 className="text-2xl font-bold text-center text-slate-800 mb-1">Acceso Seguro</h2>
                        <p className="text-center text-slate-500 text-sm mb-6">Plataforma de Gesti贸n</p>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-600 uppercase mb-1">Usuario</label>
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        value={user}
                                        onChange={(e) => setUser(e.target.value)}
                                        className="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition text-sm"
                                        placeholder="Ingrese su usuario"
                                    />
                                    <Icons.User className="w-4 h-4 text-slate-400 absolute left-3 top-3.5" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-600 uppercase mb-1">Contrase帽a</label>
                                <div className="relative">
                                    <input 
                                        type="password" 
                                        value={pass}
                                        onChange={(e) => setPass(e.target.value)}
                                        className="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition text-sm"
                                        placeholder="Ingrese su contrase帽a"
                                    />
                                    <Icons.ShieldAlert className="w-4 h-4 text-slate-400 absolute left-3 top-3.5" />
                                </div>
                            </div>
                            
                            {error && (
                                <div className="p-3 bg-red-50 text-red-600 text-xs rounded-lg flex items-center gap-2">
                                    <Icons.AlertTriangle className="w-4 h-4" />
                                    {error}
                                </div>
                            )}

                            <button type="submit" className="w-full bg-slate-800 text-white py-2.5 rounded-lg font-bold hover:bg-slate-900 transition transform active:scale-[0.98] shadow-sm">
                                Ingresar
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [portfolio, setPortfolio] = useState('alocredit');
            const activeConfig = PORTFOLIO_CONFIG[portfolio];

            const [data, setData] = useState([]);
            const [headers, setHeaders] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            
            // Filtros
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedSeller, setSelectedSeller] = useState('');
            const [selectedDevice, setSelectedDevice] = useState('');
            const [showOnlyAlerts, setShowOnlyAlerts] = useState(false);
            
            // Filtros interactivos
            const [fpdQuotaFilter, setFpdQuotaFilter] = useState(null); 
            const [breakdownFilter, setBreakdownFilter] = useState(null);

            // Reporte Vendedores
            const [showSellerModal, setShowSellerModal] = useState(false);
            const [reportFilter, setReportFilter] = useState('fpd7');
            const [detailSeller, setDetailSeller] = useState(null); // Nuevo estado para Drill-down

            // --- ESTADOS PARA EDICIN ---
            const [editModal, setEditModal] = useState({ show: false, row: null, colName: null, currentValue: '' });
            const [isSaving, setIsSaving] = useState(false);

            // --- UTILS ---
            const parseDate = (dateVal) => {
                if (!dateVal) return null;
                let dateObj = null;
                if (typeof dateVal === 'string' && dateVal.length > 5) {
                    dateObj = new Date(dateVal);
                } else if (dateVal instanceof Date) {
                    dateObj = dateVal;
                }
                if (!dateObj || isNaN(dateObj.getTime())) return null;
                return dateObj;
            };

            const checkDateAlert = (dateVal) => {
                const dateObj = parseDate(dateVal);
                if (!dateObj) return false;
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const due = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
                const diffTime = today - due;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                return diffDays >= 5 && diffDays <= 7;
            };

            const findColumnName = useCallback((keyword1, keyword2, headersList) => {
                if (!headersList) return null;
                return headersList.find(h => {
                    const lower = String(h).toLowerCase();
                    return lower.includes(keyword1) && (keyword2 ? lower.includes(keyword2) : true);
                });
            }, []);

            const findConfigColumn = useCallback((possibleNames, headersList) => {
                if (!possibleNames || !headersList) return null;
                for (const name of possibleNames) {
                    const found = headersList.find(h => h.toLowerCase().includes(name));
                    if (found) return found;
                }
                return null;
            }, []);

            const formatCellData = (value) => {
                if (typeof value !== 'string') {
                    if (typeof value === 'object' && value !== null) return JSON.stringify(value);
                    return String(value);
                }
                if (value.length > 5 && value.length < 30 && (value.includes('-') || value.includes('/'))) {
                    const d = parseDate(value);
                    if (d && !isNaN(d.getTime())) return d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                }
                return value;
            };

            const cleanPhoneNumber = (phone) => {
                if (!phone) return '';
                return String(phone).replace(/\D/g, '');
            };

            const getWhatsAppLink = (phone, clientName, deviceName) => {
                const clean = cleanPhoneNumber(phone);
                if (!clean) return '#';
                
                const isPayjoy = portfolio === 'payjoy';
                const companyName = isPayjoy ? 'Payjoy' : 'Alocredit';
                
                let name = "Cliente";
                if (clientName && typeof clientName === 'string' && clientName.trim().length > 1) {
                    name = clientName.trim(); 
                }

                let deviceRef = "equipo";
                if (deviceName && typeof deviceName === 'string' && deviceName.trim().length > 1) {
                    deviceRef = `equipo ${deviceName.trim()}`;
                }

                let paymentChannels = "";
                if (isPayjoy) {
                    paymentChannels = " Bancolombia: Convenio 85786\n Efecty: Convenio 112090";
                } else {
                    paymentChannels = " Bancolombia: Convenio 92380\n Efecty: Convenio 112978";
                }

                const message = `隆AVISO IMPORTANTE! Cuota vencida - ${companyName} 锔\n\nHola, ${name}. Te informamos que tu cr茅dito presenta un retraso. Evita bloqueos en tu ${deviceRef} realizando tu pago hoy mismo a trav茅s de nuestros canales autorizados:\n\n${paymentChannels}\n\nUna vez realizado, env铆anos la foto del soporte para registrarlo de inmediato en el sistema. `;
                
                return `https://wa.me/${clean}?text=${encodeURIComponent(message)}`;
            };

            const getCohortRange = (weeksAgo) => {
                const now = new Date();
                const currentDay = now.getDay(); 
                const distanceToMonday = (currentDay === 0 ? 6 : currentDay - 1); 
                const currentMonday = new Date(now);
                currentMonday.setDate(now.getDate() - distanceToMonday);
                currentMonday.setHours(0, 0, 0, 0);

                const start = new Date(currentMonday);
                start.setDate(currentMonday.getDate() - (weeksAgo * 7));
                
                const end = new Date(start);
                end.setDate(start.getDate() + 6);
                end.setHours(23, 59, 59, 999);
                return { start, end };
            };

            const isObsUnpaid = (val) => {
                const v = String(val || '').toLowerCase().trim();
                // Reglas estrictas de PAGO vs NO PAGO (basadas en columna PAGOS)
                if (v.includes('pago') || v.includes('pag贸') || v.includes('cancelo') || v.includes('cancel贸')) {
                    if (v.includes('no se') || v.includes('no cancelo') || v.includes('no pago')) return true; // Falso positivo de "no pago"
                    return false; // Pag贸
                }
                
                // Si est谩 vac铆o o tiene texto de compromiso pero no de pago confirmado
                if (v.includes('compromiso') || v === '' || v.includes('pendiente')) return true;
                
                // Por defecto, si tiene algo escrito pero no dice "pago", asumimos mora
                return true;
            };

            const getStatus = (val) => {
                const v = String(val || '').toLowerCase().trim();
                if (!v) return 'empty';
                // L贸gica simple para reporte
                if (v.includes('pago') || v.includes('pag贸') || v.includes('cancelo') || v.includes('cancel贸')) {
                     if (v.includes('no se') || v.includes('no cancelo') || v.includes('no pago')) return 'unpaid';
                     return 'clean';
                }
                if (v.includes('compromiso') || v.includes('gestion') || v.includes('gesti贸n')) return 'managed';
                return 'unpaid'; 
            };

            // --- FETCH DATA ---
            const fetchData = useCallback(async () => {
                setLoading(true);
                setError(null);
                setSelectedSeller('');
                setSelectedDevice('');
                setFpdQuotaFilter(null);
                setBreakdownFilter(null);
                setShowOnlyAlerts(false);

                try {
                    const separator = API_URL.includes('?') ? '&' : '?';
                    const cacheBusterUrl = `${API_URL}${separator}type=${portfolio}&t=${new Date().getTime()}`;
                    const response = await fetch(cacheBusterUrl, { method: "GET", redirect: "follow" });
                    
                    if (!response.ok) throw new Error(`Error servidor: ${response.status}`);
                    
                    const text = await response.text();
                    let jsonData;
                    try {
                        jsonData = JSON.parse(text);
                    } catch (e) {
                        throw new Error('Respuesta no v谩lida del servidor.');
                    }
                    
                    if (!Array.isArray(jsonData) || jsonData.length === 0) {
                         if (jsonData && jsonData.result === 'error') throw new Error(jsonData.error);
                         throw new Error('La hoja est谩 vac铆a.');
                    }

                    const keys = Object.keys(jsonData[0]);
                    setHeaders(keys);
                    setData(jsonData);
                } catch (err) {
                    console.error(err);
                    setError(String(err.message || 'Error desconocido.'));
                    setData([]);
                    setHeaders([]);
                } finally {
                    setLoading(false);
                }
            }, [portfolio]); 

            useEffect(() => { 
                if (isAuthenticated) fetchData(); 
            }, [fetchData, isAuthenticated]);

            // --- MEMOS DE DATOS ---
            const { sellers, sellerColumn, devices, deviceColumn, phoneColumn, clientColumn } = useMemo(() => {
                const sCol = findConfigColumn(activeConfig.columns.seller, headers);
                const dCol = findConfigColumn(activeConfig.columns.device, headers);
                const pCol = findConfigColumn(activeConfig.columns.phone, headers);
                const cCol = findConfigColumn(activeConfig.columns.client, headers); 

                const uniqueSellers = new Set();
                const uniqueDevices = new Set();
                data.forEach(row => {
                    if (sCol && row[sCol]) uniqueSellers.add(String(row[sCol]).trim());
                    if (dCol && row[dCol]) uniqueDevices.add(String(row[dCol]).trim());
                });
                return { 
                    sellers: Array.from(uniqueSellers).sort(), sellerColumn: sCol,
                    devices: Array.from(uniqueDevices).sort(), deviceColumn: dCol,
                    phoneColumn: pCol, clientColumn: cCol
                };
            }, [data, headers, activeConfig, findConfigColumn]);

            // --- REPORTE DE VENDEDORES (Corregido para usar columna PAGOS) ---
            const sellerReportData = useMemo(() => {
                if (!showSellerModal || !sellerColumn) return [];
                const dateCol = findConfigColumn(activeConfig.columns.date, headers);
                if (!dateCol) return [];

                let filterRanges = [];
                const now = new Date();

                if (reportFilter === 'fpd7') {
                     filterRanges = [getCohortRange(3)];
                } else if (reportFilter === 'current') {
                     filterRanges = [{
                        start: new Date(now.getFullYear(), now.getMonth(), 1),
                        end: new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59)
                     }];
                } else if (reportFilter === 'last') {
                     filterRanges = [{
                        start: new Date(now.getFullYear(), now.getMonth() - 1, 1),
                        end: new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59)
                     }];
                } else {
                     filterRanges = [{ start: new Date(2000, 0, 1), end: new Date(2100, 0, 1) }];
                }

                const report = {}; 

                data.forEach(row => {
                    const d = parseDate(row[dateCol]);
                    if (!d) return;
                    const isInRange = filterRanges.some(r => d >= r.start && d <= r.end);
                    if (!isInRange) return;

                    const sellerName = String(row[sellerColumn] || 'Sin Asignar').trim().toUpperCase();
                    if (!report[sellerName]) {
                        report[sellerName] = { name: sellerName, total: 0, pagas: 0, gestion: 0, noCancelo: 0, vacio: 0 };
                    }
                    report[sellerName].total++;
                    
                    // Buscamos la columna de estado de PAGO (paymentStatus)
                    const qName = 'primera';
                    let statusCol = findColumnName(activeConfig.columns.paymentStatus, qName, headers);
                    // FALLBACK INTELIGENTE
                    if (!statusCol) {
                        statusCol = findColumnName(activeConfig.columns.paymentStatus, '', headers);
                    }
                    
                    const status = getStatus(statusCol ? row[statusCol] : '');
                    if (status === 'clean') report[sellerName].pagas++;      
                    else if (status === 'managed') report[sellerName].gestion++; 
                    else if (status === 'unpaid') report[sellerName].noCancelo++; 
                    else report[sellerName].vacio++; 
                });

                return Object.values(report).map(r => {
                    const numerator = r.noCancelo + r.gestion;
                    const index = r.total > 0 ? (numerator / r.total) * 100 : 0;
                    return { ...r, index: index.toFixed(1) };
                }).sort((a, b) => b.index - a.index);
            }, [showSellerModal, reportFilter, data, headers, activeConfig, findColumnName, findConfigColumn, portfolio, sellerColumn]);

            // --- DETALLE VENDEDOR (DRILL-DOWN) ---
            const sellerDetailData = useMemo(() => {
                if (!detailSeller) return [];
                const dateCol = findConfigColumn(activeConfig.columns.date, headers);
                // Encontrar nuevas columnas
                const idCol = findConfigColumn(activeConfig.columns.id, headers);
                const emailCol = findConfigColumn(activeConfig.columns.email, headers);
                const phoneCol = findConfigColumn(activeConfig.columns.phone, headers);
                const clientCol = findConfigColumn(activeConfig.columns.client, headers);
                const deviceCol = findConfigColumn(activeConfig.columns.device, headers);

                // Reutilizar rango de fechas
                let filterRanges = [];
                const now = new Date();
                if (reportFilter === 'fpd7') filterRanges = [getCohortRange(3)];
                else if (reportFilter === 'current') filterRanges = [{start: new Date(now.getFullYear(), now.getMonth(), 1), end: new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59)}];
                else if (reportFilter === 'last') filterRanges = [{start: new Date(now.getFullYear(), now.getMonth() - 1, 1), end: new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59)}];
                else filterRanges = [{start: new Date(2000, 0, 1), end: new Date(2100, 0, 1)}];

                const result = [];

                data.forEach(row => {
                    const d = parseDate(row[dateCol]);
                    if (!d) return;
                    const isInRange = filterRanges.some(r => d >= r.start && d <= r.end);
                    if (!isInRange) return;

                    const rowSeller = String(row[sellerColumn] || 'Sin Asignar').trim().toUpperCase();
                    if (rowSeller !== detailSeller) return;

                    // Estado
                    const qName = 'primera';
                    let statusCol = findColumnName(activeConfig.columns.paymentStatus, qName, headers);
                    if (!statusCol) statusCol = findColumnName(activeConfig.columns.paymentStatus, '', headers);
                    const status = getStatus(statusCol ? row[statusCol] : '');

                    result.push({
                        name: clientCol ? row[clientCol] : '-',
                        id: idCol ? row[idCol] : '-',
                        phone: phoneCol ? row[phoneCol] : '-',
                        email: emailCol ? row[emailCol] : '-',
                        device: deviceCol ? row[deviceCol] : '-',
                        status: status === 'clean' ? 'Pag贸' : status === 'managed' ? 'Gesti贸n' : status === 'unpaid' ? 'Mora' : 'Sin Dato',
                        statusCode: status
                    });
                });
                
                // Ordenar: Mora primero
                return result.sort((a,b) => {
                    const weight = { 'Mora': 3, 'Gesti贸n': 2, 'Sin Dato': 1, 'Pag贸': 0 };
                    return weight[b.status] - weight[a.status];
                });

            }, [detailSeller, reportFilter, data, headers, activeConfig, findColumnName, findConfigColumn, portfolio, sellerColumn]);


            const handleExportPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const tableColumn = ["Vendedor", "Total", "Pagas", "Gesti贸n", "No Canc.", "Sin Dato", "Mora %"];
                const tableRows = [];
                sellerReportData.forEach(row => {
                    tableRows.push([row.name, row.total, row.pagas, row.gestion, row.noCancelo, row.vacio, `${row.index}%`]);
                });
                doc.setFontSize(16);
                doc.text(`Reporte de Vendedores - ${portfolio.toUpperCase()}`, 14, 15);
                doc.setFontSize(10);
                const filterName = reportFilter === 'fpd7' ? 'FPD7 (3 Semanas)' : reportFilter === 'current' ? 'Este Mes' : reportFilter === 'last' ? 'Mes Pasado' : 'Toda la Cartera';
                doc.text(`Filtro Aplicado: ${filterName}`, 14, 22);
                doc.text(`Generado: ${new Date().toLocaleString()}`, 14, 28);
                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 35,
                    theme: 'grid',
                    headStyles: { fillColor: [79, 70, 229] }, 
                    styles: { fontSize: 9 },
                    alternateRowStyles: { fillColor: [245, 247, 255] }
                });
                doc.save(`Reporte_Vendedores_${portfolio}_${new Date().toISOString().slice(0,10)}.pdf`);
            };

            const handleExportDetailPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const tableColumn = ["Cliente", "C茅dula", "Celular", "Correo", "Equipo", "Estado"];
                const tableRows = [];
                sellerDetailData.forEach(row => {
                    tableRows.push([row.name, row.id, row.phone, row.email, row.device, row.status]);
                });
                
                doc.setFontSize(16);
                doc.text(`Detalle de Clientes - ${detailSeller}`, 14, 15);
                doc.setFontSize(10);
                doc.text(`Cartera: ${portfolio.toUpperCase()} | Fecha: ${new Date().toLocaleDateString()}`, 14, 22);
                
                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 30,
                    theme: 'grid',
                    headStyles: { fillColor: [63, 81, 181] }, 
                    styles: { fontSize: 8 },
                    // Colorear filas seg煤n estado
                    didParseCell: function(data) {
                        if (data.section === 'body' && data.column.index === 5) {
                            const val = data.cell.raw;
                            if (val === 'Mora') data.cell.styles.textColor = [220, 38, 38];
                            else if (val === 'Pag贸') data.cell.styles.textColor = [22, 163, 74];
                            else if (val === 'Gesti贸n') data.cell.styles.textColor = [37, 99, 235];
                        }
                    }
                });
                doc.save(`Detalle_${detailSeller}_${portfolio}.pdf`);
            };

            // --- LGICA DE GUARDADO DE COMENTARIOS ---
            const handleSaveComment = async () => {
                if (!editModal.row || !editModal.currentValue.trim()) return;
                
                setIsSaving(true);
                const phone = editModal.row[phoneColumn];
                
                const payload = {
                    type: portfolio,
                    phone: phone,
                    comment: editModal.currentValue,
                    column: editModal.colName, 
                    append: true // Modo historial
                };

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(payload)
                    });

                    // Optimistic UI Update
                    const newData = data.map(r => {
                         if (String(r[phoneColumn]).replace(/\D/g, '') === String(phone).replace(/\D/g, '')) {
                             const dateStr = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                             const newEntry = `[${dateStr}] ${editModal.currentValue}`;
                             const oldVal = r[editModal.colName] || '';
                             return { ...r, [editModal.colName]: `${newEntry} | ${oldVal}` };
                         }
                         return r;
                    });
                    
                    setData(newData);
                    setEditModal({ ...editModal, show: false, currentValue: '' });

                } catch (e) {
                    alert("Error al guardar: " + e.message);
                } finally {
                    setIsSaving(false);
                }
            };

            // --- RENDERIZADO TABLA ---
            const checkSpecificQuotaAlert = (row, headersList, quotaId) => {
                const qName = QUOTA_LABELS[quotaId]?.id; 
                if (!qName) return false;
                const colFecha = findColumnName(qName, activeConfig.columns.quotaDate, headersList);
                
                // BUSCA COLUMNA DE PAGOS para saber el estado
                let colStatus = findColumnName(activeConfig.columns.paymentStatus, qName, headersList);
                
                // FALLBACK INTELIGENTE (Crucial para Payjoy "Pagos" vs "Primera Pagos")
                if (!colStatus) {
                    colStatus = findColumnName(activeConfig.columns.paymentStatus, '', headersList);
                }

                if (colFecha && colStatus) {
                    const fechaVal = row[colFecha];
                    const obsVal = String(row[colStatus] || '').trim();
                    if (checkDateAlert(fechaVal) && isObsUnpaid(obsVal)) return true;
                }
                return false;
            };

            const getRowAlertStatus = (row, headersList) => {
                return activeConfig.quotas.some(qId => checkSpecificQuotaAlert(row, headersList, qId));
            };

            const filteredData = useMemo(() => {
                let result = data;
                if (selectedSeller && sellerColumn) result = result.filter(row => String(row[sellerColumn]).trim() === selectedSeller);
                if (selectedDevice && deviceColumn) result = result.filter(row => String(row[deviceColumn]).trim() === selectedDevice);
                if (searchTerm) result = result.filter(row => headers.some(header => String(row[header]).toLowerCase().includes(searchTerm.toLowerCase())));
                if (showOnlyAlerts) result = result.filter(row => getRowAlertStatus(row, headers));

                if (fpdQuotaFilter) {
                    const dateCol = findConfigColumn(activeConfig.columns.date, headers);
                    if (dateCol) {
                        const weeksAgo = QUOTA_LABELS[fpdQuotaFilter].weeksAgo;
                        const range = getCohortRange(weeksAgo);
                        result = result.filter(row => {
                            const d = parseDate(row[dateCol]);
                            if (!d || d < range.start || d > range.end) return false;
                            
                            // FILTRO POR MORA: Mira columna de PAGOS
                            let quotaName = QUOTA_LABELS[fpdQuotaFilter].id;
                            let statusCol = findColumnName(activeConfig.columns.paymentStatus, quotaName, headers);
                            if (!statusCol) statusCol = findColumnName(activeConfig.columns.paymentStatus, '', headers);
                            
                            return statusCol ? isObsUnpaid(row[statusCol]) : false;
                        });
                    }
                }
                return result;
            }, [data, headers, searchTerm, showOnlyAlerts, fpdQuotaFilter, breakdownFilter, selectedSeller, sellerColumn, selectedDevice, deviceColumn, activeConfig, findColumnName, findConfigColumn, portfolio]);

            // --- ESTADISTICAS ---
            const dataForStats = useMemo(() => {
                let result = data;
                if (selectedSeller && sellerColumn) result = result.filter(row => String(row[sellerColumn]).trim() === selectedSeller);
                if (selectedDevice && deviceColumn) result = result.filter(row => String(row[deviceColumn]).trim() === selectedDevice);
                return result;
            }, [data, selectedSeller, sellerColumn, selectedDevice, deviceColumn]);

            const alertStats = useMemo(() => {
                let stats = { total: 0 };
                dataForStats.forEach(row => { if (getRowAlertStatus(row, headers)) stats.total++; });
                return stats;
            }, [dataForStats, headers, activeConfig]);

            const fpdStats = useMemo(() => {
                const dateCol = findConfigColumn(activeConfig.columns.date, headers);
                if (!dateCol) return { found: false };
                const formatDateShort = (d) => d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                const now = new Date(); now.setHours(0,0,0,0);
                const calculateFPD = (quotaKey) => {
                    const weeksAgo = QUOTA_LABELS[quotaKey].weeksAgo;
                    const range = getCohortRange(weeksAgo);
                    const cohortSales = dataForStats.filter(row => {
                        const d = parseDate(row[dateCol]);
                        return d && d >= range.start && d <= range.end;
                    });
                    const totalSales = cohortSales.length;
                    const rangeStr = `${formatDateShort(range.start)} - ${formatDateShort(range.end)}`;
                    if (totalSales === 0) return { totalSales: 0, unpaid: 0, rangeStr };
                    
                    // STATS: Mira columna PAGOS
                    let statusCol = findColumnName(activeConfig.columns.paymentStatus, QUOTA_LABELS[quotaKey].id, headers);
                    if (!statusCol) statusCol = findColumnName(activeConfig.columns.paymentStatus, '', headers);
                    let unpaid = statusCol ? cohortSales.filter(row => isObsUnpaid(row[statusCol])).length : 0;
                    return { totalSales, unpaid, rangeStr };
                };
                const fpd3 = calculateFPD('fpd3');
                const fpd7 = calculateFPD('fpd7');
                const fpd15 = calculateFPD('fpd15');
                let totalUnpaid = 0, totalSales = 0;
                [fpd3, fpd7, fpd15].forEach(s => { if (s) { totalUnpaid += s.unpaid; totalSales += s.totalSales; } });
                const generalFPD = totalSales > 0 ? ((totalUnpaid / totalSales) * 100).toFixed(1) : 0;
                return { found: true, colUsed: String(dateCol), generalFPD, totalSalesAll: totalSales, fpd3, fpd7, fpd15 };
            }, [dataForStats, headers, activeConfig, findColumnName, findConfigColumn, portfolio]);

            const observationStats = useMemo(() => {
                const calc = (quotaKey) => {
                    const qName = QUOTA_LABELS[quotaKey].id;
                    let s = { conGestion: 0, noCancelo: 0, yaCancelo: 0, vacio: 0 };
                    
                    // STATS DETALLADAS: Mira columna PAGOS
                    let col = findColumnName(activeConfig.columns.paymentStatus, qName, headers);
                    if (!col) col = findColumnName(activeConfig.columns.paymentStatus, '', headers);
                    
                    if(!col) return s;
                    filteredData.forEach(row => {
                        const val = String(row[col] || '').toLowerCase().trim();
                        // Mismo status que getStatus
                        if (!val) s.vacio++;
                        else if (val.includes('no se cancelo cuota')) s.noCancelo++;
                        else if (val.includes('no cancelo') || val.includes('no cancel贸') || val.includes('no pago')) s.noCancelo++;
                        
                        else if (val.includes('pago') || val.includes('cancelo')) s.yaCancelo++; // Si dice pago es pago
                        else if (val.includes('compromiso') || val.includes('gestion')) s.conGestion++;
                        else s.noCancelo++; // Default a no cancelo si hay texto raro
                    });
                    return s;
                }
                return { fpd3: calc('fpd3'), fpd7: calc('fpd7'), fpd15: calc('fpd15'), found: true };
            }, [filteredData, headers, findColumnName, activeConfig, portfolio]);

            const getColumnStyles = (headerName) => {
                if (!headerName) return null;
                const lowerHeader = String(headerName).toLowerCase().trim();
                if (lowerHeader.includes("primera cuota")) return { head: "bg-blue-100 text-blue-900 border-b-2 border-blue-300", cellBase: "border-l border-r border-blue-100", bgColor: "bg-blue-50/50" };
                return null;
            };

            const StatCard = ({ title, stats, quotaId, fpdInfo }) => {
                if (!stats) return null;
                let fpdPercent = "0.0", recoverNeeded = 0, targetPercent = 10;
                let hasSales = fpdInfo && fpdInfo.totalSales > 0;
                if (hasSales) {
                    fpdPercent = ((fpdInfo.unpaid / fpdInfo.totalSales) * 100).toFixed(1);
                    const maxAllowed = Math.floor((fpdInfo.totalSales * targetPercent) / 100);
                    recoverNeeded = Math.max(0, fpdInfo.unpaid - maxAllowed);
                }
                let fpdColor = hasSales ? (parseFloat(fpdPercent) > 30 ? "text-red-700 bg-red-100" : parseFloat(fpdPercent) > 15 ? "text-yellow-700 bg-yellow-100" : "text-green-700 bg-green-100") : "text-slate-500 bg-slate-100";
                const isFpdActive = fpdQuotaFilter === quotaId;
                const isActive = (t) => breakdownFilter && breakdownFilter.quota === quotaId && breakdownFilter.type === t;
                const baseRow = "flex justify-between items-center p-2 rounded cursor-pointer transition-colors hover:ring-1 hover:ring-indigo-300";
                return (
                    <div className={`p-4 rounded-xl border shadow-sm bg-white border-slate-200`}>
                        <div className="flex items-center gap-2 mb-3 border-b pb-2">
                             <Icons.FileText className="w-4 h-4 text-slate-600" />
                             <h3 className="text-sm font-bold uppercase tracking-wide text-slate-700">{title}</h3>
                        </div>
                        <div onClick={() => { if(hasSales) { setFpdQuotaFilter(isFpdActive ? null : quotaId); setBreakdownFilter(null); setShowOnlyAlerts(false); }}} className={`mb-3 p-3 rounded-lg ${fpdColor} border border-white/50 shadow-sm transition-all ${hasSales ? 'cursor-pointer hover:ring-2 hover:ring-indigo-400' : ''} ${isFpdActive ? 'ring-2 ring-indigo-500' : ''}`}>
                            <div className="flex justify-between mb-2">
                                <span className="text-[10px] font-bold uppercase opacity-80 flex items-center gap-1">{isFpdActive && <Icons.Filter className="w-3 h-3 animate-pulse"/>} FPD7 (Sem -{QUOTA_LABELS[quotaId].weeksAgo})</span>
                                <span className="text-xl font-bold">{hasSales ? `${fpdPercent}%` : 'N/A'}</span>
                            </div>
                            {hasSales && fpdInfo ? (
                                <div className="text-[11px] space-y-1 border-t border-black/10 pt-2">
                                    <div className="flex justify-between"><span className="opacity-80">Ventas:</span><span className="font-bold">{fpdInfo.totalSales}</span></div>
                                    <div className={`flex justify-between p-1 -mx-1 rounded ${isFpdActive ? 'bg-white/40 font-bold' : ''}`}>
                                        <span className="opacity-80">No Han Pagado:</span><span className="font-bold underline">{fpdInfo.unpaid}</span>
                                    </div>
                                    <div className="flex justify-between text-red-800 font-bold mt-1 bg-white/30 p-1 rounded -mx-1">
                                        <span className="text-[10px] flex items-center gap-1"><Icons.Target className="w-3 h-3"/> Meta {targetPercent}%:</span><span>{recoverNeeded}</span>
                                    </div>
                                    <div className="text-[9px] text-right opacity-60 pt-1 mt-1 border-t border-black/5">{fpdInfo.rangeStr}</div>
                                </div>
                            ) : <span className="text-[10px] opacity-70">Sin ventas en {fpdInfo ? fpdInfo.rangeStr : 'periodo'}</span>}
                        </div>
                        <div className="space-y-1">
                             <div onClick={() => { setBreakdownFilter({quota: quotaId, type: 'yaCancelo'}); setFpdQuotaFilter(null); }} className={`${baseRow} ${isActive('yaCancelo') ? 'bg-green-100 ring-2 ring-green-500' : 'bg-slate-50'}`}><span className="text-xs font-bold text-green-700 flex gap-1"><Icons.DollarSign className="w-3 h-3"/> Ya Cancel贸</span><span className="font-bold">{stats.yaCancelo}</span></div>
                             <div onClick={() => { setBreakdownFilter({quota: quotaId, type: 'conGestion'}); setFpdQuotaFilter(null); }} className={`${baseRow} ${isActive('conGestion') ? 'bg-blue-100 ring-2 ring-blue-500' : 'bg-slate-50'}`}><span className="text-xs font-bold text-blue-700 flex gap-1"><Icons.Handshake className="w-3 h-3"/> Con Gesti贸n</span><span className="font-bold">{stats.conGestion}</span></div>
                             <div onClick={() => { setBreakdownFilter({quota: quotaId, type: 'noCancelo'}); setFpdQuotaFilter(null); }} className={`${baseRow} ${isActive('noCancelo') ? 'bg-red-100 ring-2 ring-red-500' : 'bg-slate-50'}`}><span className="text-xs font-bold text-red-600 flex gap-1"><Icons.XCircle className="w-3 h-3"/> No Cancel贸</span><span className="font-bold">{stats.noCancelo}</span></div>
                             <div onClick={() => { setBreakdownFilter({quota: quotaId, type: 'vacio'}); setFpdQuotaFilter(null); }} className={`${baseRow} ${isActive('vacio') ? 'bg-slate-200 ring-2 ring-slate-500' : 'bg-slate-50'}`}><span className="text-xs font-bold text-slate-500 flex gap-1"><Icons.HelpCircle className="w-3 h-3"/> Sin dato</span><span className="font-bold">{stats.vacio}</span></div>
                        </div>
                    </div>
                );
            };

            const headerColorClass = activeConfig.theme === 'indigo' ? 'border-indigo-500' : 'border-blue-500';

            if (!isAuthenticated) return <Login onLogin={() => setIsAuthenticated(true)} />;

            return (
                <div className="max-w-7xl mx-auto p-4 space-y-6">
                    <div className={`bg-white rounded-xl shadow p-6 border-l-4 ${headerColorClass} flex flex-col md:flex-row justify-between items-center gap-4`}>
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-slate-100 rounded-lg"><Icons.CreditCard className={`w-6 h-6 text-${activeConfig.theme}-600`} /></div>
                            <div>
                                <h1 className="text-2xl font-bold text-slate-900">Dashboard de Gesti贸n</h1>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className={`inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium ${loading ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}`}>
                                        <span className={`w-2 h-2 rounded-full ${loading ? 'bg-amber-500 animate-pulse' : 'bg-emerald-500'}`}></span>
                                        {loading ? 'Sincronizando...' : `Actualizado: ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div className="flex bg-slate-100 p-1.5 rounded-lg items-center gap-3">
                            <div className="relative">
                                <Icons.Database className="w-3 h-3 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" />
                                <select value={portfolio} onChange={(e) => setPortfolio(e.target.value)} className="appearance-none bg-white border border-slate-200 text-slate-700 font-bold text-sm py-2 pl-3 pr-8 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer min-w-[150px]">
                                    <option value="alocredit">Cartera A</option>
                                    <option value="payjoy">Cartera P</option>
                                </select>
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                    <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                </div>
                            </div>
                            <div className="h-6 w-px bg-slate-200 mx-1"></div>
                            <button 
                                onClick={() => setShowSellerModal(true)} 
                                className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-600 to-violet-600 text-white rounded-lg hover:from-indigo-700 hover:to-violet-700 transition-all shadow-md hover:shadow-lg hover:-translate-y-0.5 font-bold text-sm"
                            >
                                <Icons.BarChart4 className="w-4 h-4"/> Reporte Vendedores
                            </button>
                            <button onClick={fetchData} disabled={loading} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-white rounded-md transition-all disabled:opacity-50" title="Recargar datos"><Icons.RefreshCw className={`w-5 h-5 ${loading ? 'animate-spin' : ''}`} /></button>
                        </div>
                    </div>

                    {error && <div className="bg-red-50 p-4 rounded-lg border border-red-200 flex gap-3 text-red-700 items-start"><Icons.AlertCircle className="w-5 h-5 mt-0.5 flex-shrink-0"/><div><h3 className="font-bold text-sm">Error de Conexi贸n</h3><p className="text-xs mt-1">{String(error)}</p></div></div>}

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div className="bg-white p-3 rounded-lg shadow-sm border border-slate-200">
                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Vendedor</label>
                            <div className="relative">
                                <select className="w-full p-2 bg-slate-50 border border-slate-100 rounded text-sm text-slate-700 outline-none focus:border-indigo-500" value={selectedSeller} onChange={e => setSelectedSeller(e.target.value)}>
                                    <option value="">Todos</option>
                                    {sellers.map((s,i) => <option key={i} value={s}>{s}</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="bg-white p-3 rounded-lg shadow-sm border border-slate-200">
                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Equipo</label>
                            <div className="relative">
                                <select className="w-full p-2 bg-slate-50 border border-slate-100 rounded text-sm text-slate-700 outline-none focus:border-indigo-500" value={selectedDevice} onChange={e => setSelectedDevice(e.target.value)}>
                                    <option value="">Todos</option>
                                    {devices.map((d,i) => <option key={i} value={d}>{d}</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="bg-white p-3 rounded-lg shadow-sm border border-slate-200">
                             <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">B煤squeda</label>
                             <div className="relative">
                                <input type="text" className="w-full p-2 pl-8 bg-slate-50 border border-slate-100 rounded text-sm outline-none focus:border-indigo-500" placeholder="Nombre, c茅dula..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                <Icons.Search className="w-4 h-4 text-slate-400 absolute left-2.5 top-2.5" />
                             </div>
                        </div>
                        <div className="bg-white p-3 rounded-lg shadow-sm border border-slate-200 flex justify-between items-center px-5">
                            <div><p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Clientes</p><p className="text-2xl font-bold text-slate-700">{filteredData.length}</p></div>
                            <div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><Icons.Users className="w-5 h-5" /></div>
                        </div>
                    </div>

                    {alertStats.total > 0 && (
                        <div className="bg-rose-50 border border-rose-100 rounded-xl p-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                             <div className="flex gap-4 items-center">
                                <div className="p-2.5 bg-white shadow-sm border border-rose-100 rounded-full text-rose-600"><Icons.BellRing className="w-5 h-5"/></div>
                                <div>
                                    <h2 className="text-rose-900 font-bold">{alertStats.total} Clientes en Mora Reciente</h2>
                                    <p className="text-xs text-rose-700 opacity-80">Vencidos hace 5-7 d铆as sin gesti贸n registrada.</p>
                                </div>
                             </div>
                             <button onClick={() => setShowOnlyAlerts(!showOnlyAlerts)} className={`px-5 py-2 rounded-lg text-sm font-bold border transition-all shadow-sm ${showOnlyAlerts ? 'bg-rose-600 text-white border-rose-600' : 'bg-white text-rose-600 border-rose-200 hover:bg-rose-50'}`}>
                                {showOnlyAlerts ? 'Ver Todos' : 'Filtrar Alertas'}
                             </button>
                        </div>
                    )}

                    <div className="bg-slate-100 p-4 rounded-xl border border-slate-200">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-slate-700 flex items-center gap-2"><div className="w-1 h-5 bg-indigo-500 rounded-full"></div> An谩lisis de Cohortes</h3>
                            { (fpdQuotaFilter || breakdownFilter) && 
                                <button onClick={() => { setFpdQuotaFilter(null); setBreakdownFilter(null); }} className="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-full flex gap-1.5 items-center hover:bg-slate-700 transition-colors shadow-sm">
                                    <Icons.X className="w-3 h-3"/> Quitar Filtros
                                </button>
                            }
                        </div>
                        
                        <div className="flex justify-center mb-4">
                            {fpdStats.found && (
                                <div className="bg-white px-4 py-2 rounded-full shadow-sm border border-slate-200 flex gap-4 items-center">
                                    <Icons.TrendingDown className="w-5 h-5 text-slate-400"/>
                                    <div className="text-center">
                                        <p className="text-[10px] font-bold text-slate-400 uppercase">Morosidad General</p>
                                        <p className="text-xl font-bold text-slate-700">{fpdStats.totalSalesAll > 0 ? `${fpdStats.generalFPD}%` : 'N/A'}</p>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className={`grid grid-cols-1 md:grid-cols-${activeConfig.quotas.length} gap-6`}>
                            {activeConfig.quotas.map(quotaId => (
                                <StatCard key={quotaId} title={QUOTA_LABELS[quotaId].label} quotaId={quotaId} stats={observationStats[quotaId]} fpdInfo={fpdStats[quotaId]} />
                            ))}
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm text-slate-600">
                                <thead className="bg-slate-50/80 text-xs uppercase tracking-wider font-bold text-slate-500 border-b border-slate-200">
                                    <tr>{headers.map((h, i) => {
                                        const style = getColumnStyles(h);
                                        const isPhoneCol = activeConfig.columns.phone && activeConfig.columns.phone.some(p => h.toLowerCase().includes(p));
                                        return <th key={i} className={`px-4 py-3 whitespace-nowrap ${style?.head} ${isPhoneCol ? 'min-w-[140px]' : ''}`}>{h}</th>
                                    })}</tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {filteredData.length > 0 ? filteredData.map((row, i) => (
                                        <tr key={i} className="hover:bg-slate-50 transition-colors">
                                            {headers.map((h, j) => {
                                                const val = formatCellData(row[h]);
                                                const style = getColumnStyles(h);
                                                let isAlert = false;
                                                
                                                // 1. CHEQUEO DE ALERTA (Usa columna PAGOS)
                                                if (style) {
                                                    let qName = '';
                                                    if (h.toLowerCase().includes('primera')) qName='primera';
                                                    if(qName && activeConfig.quotas.some(qId => QUOTA_LABELS[qId].id === qName) && checkSpecificQuotaAlert(row, headers, 'fpd3')) isAlert = true; 
                                                }

                                                // 2. COLUMNA DE TELEFONO
                                                const isPhoneCol = activeConfig.columns.phone && activeConfig.columns.phone.some(p => h.toLowerCase().includes(p));
                                                if (isPhoneCol) {
                                                    const clientVal = clientColumn ? row[clientColumn] : '';
                                                    const deviceVal = deviceColumn ? row[deviceColumn] : '';
                                                    const clean = cleanPhoneNumber(val);
                                                    if (clean) {
                                                        return (
                                                            <td key={j} className="px-4 py-3 whitespace-nowrap">
                                                                <div className="flex items-center gap-2">
                                                                    <span className="font-mono text-xs text-slate-500">{val}</span>
                                                                    <div className="flex gap-1">
                                                                        <a href={getWhatsAppLink(val, clientVal, deviceVal)} target="_blank" className="p-1.5 bg-green-50 text-green-600 rounded hover:bg-green-100 border border-green-200 transition-colors" title="WhatsApp"><Icons.MessageCircle className="w-3.5 h-3.5"/></a>
                                                                        <a href={`tel:${clean}`} className="p-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 border border-blue-200 transition-colors" title="Llamar"><Icons.Phone className="w-3.5 h-3.5"/></a>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        );
                                                    }
                                                }
                                                
                                                // 3. COLUMNA EDITABLE (COMENTARIOS) - Solo muestra L谩piz
                                                const isCommentsCol = activeConfig.columns.comments && (
                                                    (typeof activeConfig.columns.comments === 'string' && h.toLowerCase().includes(activeConfig.columns.comments)) ||
                                                    (Array.isArray(activeConfig.columns.comments) && activeConfig.columns.comments.some(n => h.toLowerCase().includes(n)))
                                                );

                                                if (isCommentsCol) {
                                                     return (
                                                        <td key={j} className={`px-4 py-3 whitespace-nowrap text-xs group relative ${style?.bgColor} ${isAlert ? 'bg-rose-50 text-rose-700 font-bold border-l-2 border-rose-500' : ''}`}>
                                                            {isAlert && <Icons.AlertTriangle className="w-3 h-3 inline mr-1.5"/>}
                                                            <span className="inline-block max-w-[200px] truncate" title={val}>{val}</span>
                                                            <button 
                                                                onClick={() => setEditModal({ show: true, row, colName: h, currentValue: String(row[h] || '') })}
                                                                className="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 bg-white shadow-sm border border-slate-200 rounded text-slate-400 hover:text-indigo-600 hover:border-indigo-300 transition-all z-10 opacity-100"
                                                                title="Agregar gesti贸n"
                                                            >
                                                                <Icons.Edit2 className="w-3 h-3"/>
                                                            </button>
                                                        </td>
                                                     )
                                                }

                                                // 4. CELDA NORMAL
                                                return (
                                                    <td key={j} className={`px-4 py-3 whitespace-nowrap text-xs ${style?.bgColor} ${isAlert ? 'bg-rose-50 text-rose-700 font-bold border-l-2 border-rose-500' : ''}`}>
                                                        {isAlert && <Icons.AlertTriangle className="w-3 h-3 inline mr-1.5"/>}
                                                        {val}
                                                    </td>
                                                )
                                            })}
                                        </tr>
                                    )) : (
                                        <tr><td colSpan={headers.length} className="px-6 py-24 text-center text-slate-400">
                                            <div className="flex flex-col items-center gap-3">
                                                <div className="p-4 bg-slate-50 rounded-full"><Icons.Search className="w-8 h-8 text-slate-300"/></div>
                                                <p>No se encontraron resultados con los filtros actuales.</p>
                                            </div>
                                        </td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* --- MODAL DE EDICIN (COMENTARIOS) --- */}
                    {editModal.show && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                             <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col transform transition-all scale-100">
                                <div className="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                    <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                        <div className="p-2 bg-indigo-100 rounded-lg text-indigo-600"><Icons.Edit2 className="w-4 h-4"/></div>
                                        Nueva Gesti贸n
                                    </h3>
                                    <button onClick={() => !isSaving && setEditModal({ ...editModal, show: false })} className="text-slate-400 hover:text-slate-600 transition-colors">
                                        <Icons.X className="w-5 h-5"/>
                                    </button>
                                </div>
                                <div className="p-6">
                                    <div className="mb-4">
                                        <label className="text-xs font-bold text-slate-500 uppercase block mb-2">Historial Reciente</label>
                                        <div className="bg-slate-50 p-3 rounded-lg border border-slate-200 text-xs text-slate-600 max-h-32 overflow-y-auto italic">
                                            {editModal.currentValue || "Sin comentarios previos."}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase block mb-2">Nuevo Comentario</label>
                                        <textarea 
                                            value={editModal.currentValue === (editModal.row[editModal.colName] || '') ? '' : editModal.currentValue} // Limpiamos si es igual al original para escribir nuevo
                                            onChange={(e) => setEditModal({ ...editModal, currentValue: e.target.value })}
                                            className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm min-h-[100px]"
                                            placeholder="Escribe el resultado de la gesti贸n..."
                                            autoFocus
                                        />
                                    </div>
                                </div>
                                <div className="p-5 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                                    <button 
                                        onClick={() => setEditModal({ ...editModal, show: false })} 
                                        className="px-4 py-2 text-slate-600 font-bold text-sm hover:bg-slate-200 rounded-lg transition-colors"
                                        disabled={isSaving}
                                    >
                                        Cancelar
                                    </button>
                                    <button 
                                        onClick={handleSaveComment}
                                        disabled={isSaving || !editModal.currentValue.trim()}
                                        className="px-6 py-2 bg-indigo-600 text-white font-bold text-sm rounded-lg hover:bg-indigo-700 transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                                    >
                                        {isSaving ? <><Icons.RefreshCw className="w-4 h-4 animate-spin"/> Guardando...</> : 'Guardar Gesti贸n'}
                                    </button>
                                </div>
                             </div>
                        </div>
                    )}

                    {/* --- MODAL REPORTE VENDEDORES (NIVEL 1) --- */}
                    {showSellerModal && (
                        <div id="printable-modal-content" className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-2xl no-print">
                                    <div className="flex items-center gap-4">
                                        <div>
                                            <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icons.BarChart4 className="w-6 h-6 text-indigo-600"/> Rendimiento por Vendedor</h3>
                                            <p className="text-xs text-slate-500 mt-1">An谩lisis de riesgo y gesti贸n</p>
                                        </div>
                                        <div className="relative">
                                            <select value={reportFilter} onChange={(e) => setReportFilter(e.target.value)} className="appearance-none bg-white border border-slate-300 text-slate-700 text-sm py-1.5 pl-3 pr-8 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer font-medium">
                                                <option value="fpd7"> FPD7 (3 Semanas)</option>
                                                <option value="current"> Este Mes</option>
                                                <option value="last">锔 Mes Pasado</option>
                                                <option value="all"> Toda la Cartera</option>
                                            </select>
                                            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><svg className="fill-current h-4 w-4" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg></div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button type="button" onClick={handleExportPDF} className="flex items-center gap-2 px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-md hover:bg-indigo-100 transition-colors font-bold text-sm" title="Descargar PDF"><Icons.Download className="w-4 h-4"/> Exportar PDF</button>
                                        <button onClick={() => setShowSellerModal(false)} className="p-2 hover:bg-slate-200 rounded-full text-slate-400 transition-colors"><Icons.X className="w-6 h-6"/></button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-auto p-0 custom-scrollbar">
                                    <table className="w-full text-sm text-left border-collapse">
                                        <thead className="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 z-10 shadow-sm">
                                            <tr>
                                                <th className="px-6 py-4 font-semibold border-b border-slate-200">Vendedor</th>
                                                <th className="px-4 py-4 text-center font-semibold border-b border-slate-200">Total</th>
                                                <th className="px-4 py-4 text-center font-semibold text-emerald-600 border-b border-slate-200">Pagas</th>
                                                <th className="px-4 py-4 text-center font-semibold text-blue-600 border-b border-slate-200">Gesti贸n</th>
                                                <th className="px-4 py-4 text-center font-semibold text-rose-600 border-b border-slate-200">No Canc.</th>
                                                <th className="px-4 py-4 text-center font-semibold text-slate-400 border-b border-slate-200">Sin Dato</th>
                                                <th className="px-6 py-4 text-right font-semibold border-b border-slate-200">ndice Mora</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {sellerReportData.length > 0 ? sellerReportData.map((row, idx) => (
                                                <tr key={idx} className="hover:bg-indigo-50/30 transition-colors">
                                                    <td className="px-6 py-3 font-medium text-slate-700">{row.name}</td>
                                                    <td className="px-4 py-3 text-center font-bold text-slate-800">{row.total}</td>
                                                    <td className="px-4 py-3 text-center"><span className="inline-block px-2 py-1 bg-emerald-50 text-emerald-700 rounded-md font-medium text-xs">{row.pagas}</span></td>
                                                    <td className="px-4 py-3 text-center"><span className="inline-block px-2 py-1 bg-blue-50 text-blue-700 rounded-md font-medium text-xs">{row.gestion}</span></td>
                                                    <td className="px-4 py-3 text-center"><span className="inline-block px-2 py-1 bg-rose-50 text-rose-700 rounded-md font-medium text-xs">{row.noCancelo}</span></td>
                                                    <td className="px-4 py-3 text-center text-slate-400 text-xs">{row.vacio}</td>
                                                    <td className="px-6 py-3 text-right">
                                                        {/* BOTN CLICKABLE PARA DRILL-DOWN */}
                                                        <button 
                                                            onClick={() => setDetailSeller(row.name)}
                                                            className={`px-3 py-1 rounded-full text-xs font-bold border transition-transform hover:scale-105 active:scale-95 ${parseFloat(row.index) > 20 ? 'bg-rose-100 text-rose-700 border-rose-200 hover:bg-rose-200' : parseFloat(row.index) > 10 ? 'bg-amber-100 text-amber-700 border-amber-200 hover:bg-amber-200' : 'bg-emerald-100 text-emerald-700 border-emerald-200 hover:bg-emerald-200'}`}
                                                            title="Ver lista de clientes"
                                                        >
                                                            {row.index}%
                                                        </button>
                                                    </td>
                                                </tr>
                                            )) : <tr><td colSpan="7" className="px-6 py-12 text-center text-slate-400 italic">No hay datos para el periodo seleccionado.</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="p-4 bg-slate-50 border-t border-slate-200 text-[10px] text-slate-500 flex justify-between rounded-b-2xl no-print">
                                    <span>* Mora = (No Cancel贸 + Con Gesti贸n) / Total Ventas</span>
                                    <span>Haz clic en el % para ver detalle</span>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL DETALLE CLIENTES (NIVEL 2) --- */}
                    {detailSeller && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                            <div className="bg-white w-full max-w-5xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center rounded-t-2xl">
                                    <div className="flex items-center gap-3">
                                        <button onClick={() => setDetailSeller(null)} className="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors mr-2">
                                            <Icons.ArrowLeft className="w-5 h-5"/>
                                        </button>
                                        <div>
                                            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                                <span className="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-sm uppercase">Vendedor</span> 
                                                {detailSeller}
                                            </h3>
                                            <p className="text-xs text-slate-500 mt-0.5">Listado detallado de clientes</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={handleExportDetailPDF} className="flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-md hover:bg-blue-100 transition-colors font-bold text-sm">
                                            <Icons.Download className="w-4 h-4"/> Exportar Lista
                                        </button>
                                        <button onClick={() => setDetailSeller(null)} className="p-2 hover:bg-slate-200 rounded-full text-slate-400 transition-colors">
                                            <Icons.X className="w-6 h-6"/>
                                        </button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-auto p-0 custom-scrollbar">
                                    <table className="w-full text-sm text-left border-collapse">
                                        <thead className="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 z-10 shadow-sm">
                                            <tr>
                                                <th className="px-4 py-3 font-semibold border-b border-slate-200">Cliente</th>
                                                <th className="px-4 py-3 font-semibold border-b border-slate-200">C茅dula</th>
                                                <th className="px-4 py-3 font-semibold border-b border-slate-200">Celular</th>
                                                <th className="px-4 py-3 font-semibold border-b border-slate-200">Correo</th>
                                                <th className="px-4 py-3 font-semibold border-b border-slate-200">Equipo</th>
                                                <th className="px-4 py-3 text-center font-semibold border-b border-slate-200">Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {sellerDetailData.length > 0 ? sellerDetailData.map((row, idx) => (
                                                <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                                    <td className="px-4 py-2.5 font-medium text-slate-700">{row.name}</td>
                                                    <td className="px-4 py-2.5 text-slate-500 font-mono text-xs">{row.id}</td>
                                                    <td className="px-4 py-2.5 text-slate-500 font-mono text-xs">{row.phone}</td>
                                                    <td className="px-4 py-2.5 text-slate-500 text-xs truncate max-w-[150px]" title={row.email}>{row.email}</td>
                                                    <td className="px-4 py-2.5 text-slate-600 text-xs">{row.device}</td>
                                                    <td className="px-4 py-2.5 text-center">
                                                        <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide 
                                                            ${row.statusCode === 'unpaid' ? 'bg-rose-100 text-rose-700' : 
                                                              row.statusCode === 'managed' ? 'bg-blue-100 text-blue-700' : 
                                                              row.statusCode === 'clean' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>
                                                            {row.status}
                                                        </span>
                                                    </td>
                                                </tr>
                                            )) : <tr><td colSpan="6" className="px-6 py-12 text-center text-slate-400 italic">No se encontraron clientes para este vendedor en el periodo.</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
