<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Cartera - Alocredit & Payjoy</title>
    
    <!-- 1. Estilos (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: .8; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        body { font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- ICONOS INTEGRADOS (SVG Nativos) ---
        const IconBase = ({ children, className, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" 
                height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const Icons = {
            AlertCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>,
            CheckCircle: (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            Search: (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></IconBase>,
            RefreshCw: (props) => <IconBase {...props}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconBase>,
            CreditCard: (props) => <IconBase {...props}><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></IconBase>,
            FileText: (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>,
            XCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>,
            HelpCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>,
            BellRing: (props) => <IconBase {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></IconBase>,
            Filter: (props) => <IconBase {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>,
            User: (props) => <IconBase {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            Users: (props) => <IconBase {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            TrendingDown: (props) => <IconBase {...props}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></IconBase>,
            DollarSign: (props) => <IconBase {...props}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>,
            X: (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>,
            Target: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>,
            Handshake: (props) => <IconBase {...props}><path d="m11 17 2 2a1 1 0 1 0 3-3"/><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-1.42-1.42l4.82-4.82a1 1 0 0 1 1.42 0l2.12 2.12a1 1 0 0 0 1.42 0l1.29-1.29a3 3 0 0 0 0-4.24l-2.12-2.12a3 3 0 0 0-4.24 0l-3.65 3.65a3 3 0 0 0 0 4.24l.88.88a1 1 0 0 1-1.42 1.42l-4.24-4.24a1 1 0 0 0-1.42 0l-2.12 2.12a3 3 0 0 0 0 4.24l2.12 2.12"/><path d="m7 13 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-1.42-1.42l4.82-4.82a1 1 0 0 1 1.42 0l2.12 2.12a1 1 0 0 0 1.42 0l1.29-1.29a3 3 0 0 0 0-4.24l-2.12-2.12a3 3 0 0 0-4.24 0l-3.65 3.65a3 3 0 0 0 0 4.24l.88.88a1 1 0 0 1-1.42 1.42l-4.24-4.24a1 1 0 0 0-1.42 0l-2.12 2.12a3 3 0 0 0 0 4.24l2.12 2.12"/></IconBase>,
            Smartphone: (props) => <IconBase {...props}><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></IconBase>,
            ShieldAlert: (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>,
            AlertTriangle: (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>,
            Phone: (props) => <IconBase {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></IconBase>,
            MessageCircle: (props) => <IconBase {...props}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></IconBase>
        };

        // --- CONFIGURACIÓN ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbz770i0j3vK5-9M2Z2EheDh9GX2x2j2KbjfFm_yNadBg5db3tEc5so58KWeIX5SwTmAZw/exec';
        const APP_VERSION = "v2.0.10 (WA Device)";

        const PORTFOLIO_CONFIG = {
            alocredit: {
                name: "ALOCREDIT",
                theme: "indigo",
                quotas: ['q1'], 
                columns: {
                    seller: ['responsable', 'vendedor', 'asesor'],
                    client: ['cliente', 'nombre', 'nombres', 'nombre cliente'], 
                    device: ['modelo - equipo', 'equipo', 'modelo'],
                    phone: ['celular', 'telefono', 'teléfono', 'movil', 'contacto'], 
                    date: ['fecha venta', 'fecha desembolso', 'fecha creacion', 'fecha'],
                    quotaDate: 'cuota',
                    observation: 'pagos' 
                }
            },
            payjoy: {
                name: "PAYJOY",
                theme: "blue",
                quotas: ['q1', 'q2', 'q3'], 
                columns: {
                    seller: ['vendedor', 'asesor', 'ejecutivo'],
                    client: ['cliente', 'nombre', 'nombres', 'nombre cliente'], 
                    device: ['equipo', 'modelo', 'celular'],
                    phone: ['celular', 'telefono', 'teléfono', 'movil', 'contacto'], 
                    date: ['fecha venta', 'fecha desembolso', 'fecha'],
                    quotaDate: 'cuota',
                    observation: 'observa'
                }
            }
        };
        
        const QUOTA_LABELS = {
            q1: { id: 'primera', label: 'Primera Cuota', weeksAgo: 3 },
            q2: { id: 'segunda', label: 'Segunda Cuota', weeksAgo: 6 },
            q3: { id: 'tercera', label: 'Tercera Cuota', weeksAgo: 7 }
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [portfolio, setPortfolio] = useState('alocredit');
            const activeConfig = PORTFOLIO_CONFIG[portfolio];

            const [data, setData] = useState([]);
            const [headers, setHeaders] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            
            // Filtros
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedSeller, setSelectedSeller] = useState('');
            const [selectedDevice, setSelectedDevice] = useState('');
            const [showOnlyAlerts, setShowOnlyAlerts] = useState(false);
            
            // Filtros interactivos
            const [fpdQuotaFilter, setFpdQuotaFilter] = useState(null); 
            const [breakdownFilter, setBreakdownFilter] = useState(null);

            // --- UTILS ---
            const parseDate = (dateVal) => {
                if (!dateVal) return null;
                let dateObj = null;
                if (typeof dateVal === 'string' && dateVal.length > 5) {
                    dateObj = new Date(dateVal);
                } else if (dateVal instanceof Date) {
                    dateObj = dateVal;
                }
                if (!dateObj || isNaN(dateObj.getTime())) return null;
                return dateObj;
            };

            const checkDateAlert = (dateVal) => {
                const dateObj = parseDate(dateVal);
                if (!dateObj) return false;
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const due = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
                const diffTime = today - due;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                return diffDays >= 5 && diffDays <= 7;
            };

            const findColumnName = useCallback((keyword1, keyword2, headersList) => {
                if (!headersList) return null;
                return headersList.find(h => {
                    const lower = String(h).toLowerCase();
                    return lower.includes(keyword1) && (keyword2 ? lower.includes(keyword2) : true);
                });
            }, []);

            const findConfigColumn = useCallback((possibleNames, headersList) => {
                if (!possibleNames || !headersList) return null;
                for (const name of possibleNames) {
                    const found = headersList.find(h => h.toLowerCase().includes(name));
                    if (found) return found;
                }
                return null;
            }, []);

            const formatCellData = (value) => {
                if (typeof value !== 'string') {
                    if (typeof value === 'object' && value !== null) return JSON.stringify(value);
                    return String(value);
                }
                if (value.length > 5 && value.length < 30 && !isNaN(Date.parse(value)) && (value.includes('-') || value.includes('/'))) {
                    try {
                        const date = new Date(value);
                        return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    } catch (e) { return value; }
                }
                return value;
            };

            // HELPERS PARA ACCIONES DE CELULAR
            const cleanPhoneNumber = (phone) => {
                if (!phone) return '';
                return String(phone).replace(/\D/g, '');
            };

            const getWhatsAppLink = (phone, clientName, deviceName) => {
                const clean = cleanPhoneNumber(phone);
                if (!clean) return '#';
                
                const companyName = portfolio === 'payjoy' ? 'Payjoy' : 'Alocredit';
                
                let greeting = "Hola";
                if (clientName && typeof clientName === 'string') {
                    const cleanName = clientName.trim();
                    if (cleanName.length > 1) greeting += ` ${cleanName}`;
                }

                // Texto del equipo
                let deviceText = "";
                if (deviceName && typeof deviceName === 'string' && deviceName.trim().length > 1) {
                    deviceText = ` de su equipo ${deviceName.trim()}`;
                }

                const message = `${greeting}, le recordamos que la cuota${deviceText} financiado con ${companyName} se encuentra vencida. Si ya realizó el pago por favor infórmenos.`;
                return `https://wa.me/${clean}?text=${encodeURIComponent(message)}`;
            };

            const getCohortRange = (weeksAgo) => {
                const now = new Date();
                const currentDay = now.getDay(); 
                const distanceToMonday = (currentDay === 0 ? 6 : currentDay - 1); 
                const currentMonday = new Date(now);
                currentMonday.setDate(now.getDate() - distanceToMonday);
                currentMonday.setHours(0, 0, 0, 0);

                const start = new Date(currentMonday);
                start.setDate(currentMonday.getDate() - (weeksAgo * 7));
                
                const end = new Date(start);
                end.setDate(start.getDate() + 6);
                end.setHours(23, 59, 59, 999);
                return { start, end };
            };

            const isObsUnpaid = (val) => {
                const v = String(val || '').toLowerCase().trim();
                
                // 1. REGLA ALOCREDIT
                if (v.includes('gets solutions pago cuota') || v.includes('con gestion') || v.includes('con gestión')) return false;
                
                // 2. REGLA ALOCREDIT IMPAGO
                if (v.includes('no se cancelo cuota') || v.includes('no cancelo') || v.includes('no canceló') || v.includes('no pago')) return true;

                // 3. Pagos directos
                if (v.includes('ya cancelo') || v.includes('ya canceló') || v.includes('cancelo') || v.includes('canceló') || v.includes('pagó') || v.includes('pago')) return false;
                
                // 4. Default
                return v === '' || v.includes('compromiso');
            };

            // --- FETCH DATA ---
            const fetchData = useCallback(async () => {
                setLoading(true);
                setError(null);
                setSelectedSeller('');
                setSelectedDevice('');
                setFpdQuotaFilter(null);
                setBreakdownFilter(null);
                setShowOnlyAlerts(false);

                try {
                    const separator = API_URL.includes('?') ? '&' : '?';
                    const cacheBusterUrl = `${API_URL}${separator}type=${portfolio}&t=${new Date().getTime()}`;
                    const response = await fetch(cacheBusterUrl, { method: "GET", redirect: "follow" });
                    
                    if (!response.ok) throw new Error(`Error servidor: ${response.status}`);
                    
                    const text = await response.text();
                    let jsonData;
                    try {
                        jsonData = JSON.parse(text);
                    } catch (e) {
                        throw new Error('Respuesta no válida del servidor.');
                    }
                    
                    if (!Array.isArray(jsonData) || jsonData.length === 0) {
                         if (jsonData && jsonData.result === 'error') throw new Error(jsonData.error);
                         throw new Error('La hoja está vacía.');
                    }

                    const keys = Object.keys(jsonData[0]);
                    setHeaders(keys);
                    setData(jsonData);
                } catch (err) {
                    console.error(err);
                    setError(err.message || 'Error desconocido.');
                    setData([]);
                    setHeaders([]);
                } finally {
                    setLoading(false);
                }
            }, [portfolio]); 

            useEffect(() => { fetchData(); }, [fetchData]);

            // --- MEMOS DE DATOS ---
            const { sellers, sellerColumn, devices, deviceColumn, phoneColumn, clientColumn } = useMemo(() => {
                const sCol = findConfigColumn(activeConfig.columns.seller, headers);
                const dCol = findConfigColumn(activeConfig.columns.device, headers);
                const pCol = findConfigColumn(activeConfig.columns.phone, headers);
                const cCol = findConfigColumn(activeConfig.columns.client, headers); 

                const uniqueSellers = new Set();
                const uniqueDevices = new Set();
                data.forEach(row => {
                    if (sCol && row[sCol]) uniqueSellers.add(String(row[sCol]).trim());
                    if (dCol && row[dCol]) uniqueDevices.add(String(row[dCol]).trim());
                });
                return { 
                    sellers: Array.from(uniqueSellers).sort(), sellerColumn: sCol,
                    devices: Array.from(uniqueDevices).sort(), deviceColumn: dCol,
                    phoneColumn: pCol,
                    clientColumn: cCol
                };
            }, [data, headers, activeConfig, findConfigColumn]);

            const checkSpecificQuotaAlert = (row, headersList, quotaId) => {
                const qName = QUOTA_LABELS[quotaId]?.id; 
                if (!qName) return false;
                const colFecha = findColumnName(qName, activeConfig.columns.quotaDate, headersList);
                
                let colObs = findColumnName(activeConfig.columns.observation, qName, headersList);
                if (!colObs && portfolio === 'alocredit' && quotaId === 'q1') {
                    colObs = findColumnName(activeConfig.columns.observation, '', headersList);
                }

                if (colFecha && colObs) {
                    const fechaVal = row[colFecha];
                    const obsVal = String(row[colObs] || '').trim();
                    if (checkDateAlert(fechaVal) && obsVal === '') return true;
                }
                return false;
            };

            const getRowAlertStatus = (row, headersList) => {
                return activeConfig.quotas.some(qId => checkSpecificQuotaAlert(row, headersList, qId));
            };

            // --- LOGICA DE FILTRADO PRINCIPAL ---
            const filteredData = useMemo(() => {
                let result = data;
                if (selectedSeller && sellerColumn) result = result.filter(row => String(row[sellerColumn]).trim() === selectedSeller);
                if (selectedDevice && deviceColumn) result = result.filter(row => String(row[deviceColumn]).trim() === selectedDevice);
                
                if (searchTerm) {
                    result = result.filter(row => headers.some(header => String(row[header]).toLowerCase().includes(searchTerm.toLowerCase())));
                }
                if (showOnlyAlerts) {
                    result = result.filter(row => getRowAlertStatus(row, headers));
                }

                if (fpdQuotaFilter) {
                    const dateCol = findConfigColumn(activeConfig.columns.date, headers);
                    if (dateCol) {
                        const weeksAgo = QUOTA_LABELS[fpdQuotaFilter].weeksAgo;
                        const range = getCohortRange(weeksAgo);

                        result = result.filter(row => {
                            const d = parseDate(row[dateCol]);
                            if (!d || d < range.start || d > range.end) return false;
                            
                            let quotaName = QUOTA_LABELS[fpdQuotaFilter].id;
                            
                            let obsCol = findColumnName(activeConfig.columns.observation, quotaName, headers);
                            if (!obsCol && portfolio === 'alocredit' && fpdQuotaFilter === 'q1') {
                                obsCol = findColumnName(activeConfig.columns.observation, '', headers);
                            }

                            let quotaDateCol = findColumnName(quotaName, activeConfig.columns.quotaDate, headers);
                            
                            const now = new Date(); now.setHours(0,0,0,0);
                            if (quotaDateCol) {
                                const qDate = parseDate(row[quotaDateCol]);
                                if (qDate && qDate >= now) return false; 
                            }
                            if (obsCol) return isObsUnpaid(row[obsCol]);
                            return false;
                        });
                    }
                }

                if (breakdownFilter) {
                   const { quota, type } = breakdownFilter;
                   let qName = QUOTA_LABELS[quota].id;
                   let colName = findColumnName(activeConfig.columns.observation, qName, headers);
                   if (!colName && portfolio === 'alocredit' && quota === 'q1') {
                       colName = findColumnName(activeConfig.columns.observation, '', headers);
                   }
                   
                   if (colName) {
                       result = result.filter(row => {
                           const val = String(row[colName] || '').toLowerCase().trim();
                           if (type === 'vacio') return !val;
                           
                           if (type === 'noCancelo') {
                               if (val.includes('no se cancelo cuota')) return true;
                               if (val.includes('no cancelo') || val.includes('no canceló') || val.includes('no pago')) return true;
                               return false; 
                           }
                           
                           if (type === 'conGestion') {
                               if (val.includes('gets solutions pago cuota')) return true;
                               return val.includes('ya cancelo cuota') || val.includes('con gestion') || val.includes('con gestión');
                           }
                           
                           if (type === 'yaCancelo') {
                               if (val.includes('gets solutions pago cuota') || val.includes('ya cancelo cuota') || val.includes('con gestion')) return false;
                               return val.includes('ya cancelo') || val.includes('ya canceló') || val.includes('cancelo') || val.includes('canceló') || val.includes('pagó') || val.includes('pago');
                           }
                           
                           if (type === 'compromiso') return val.includes('compromiso');

                           return false;
                       });
                   }
                }
                return result;
            }, [data, headers, searchTerm, showOnlyAlerts, fpdQuotaFilter, breakdownFilter, selectedSeller, sellerColumn, selectedDevice, deviceColumn, activeConfig, findColumnName, findConfigColumn, portfolio]);

            // --- ESTADISTICAS ---
            const dataForStats = useMemo(() => {
                let result = data;
                if (selectedSeller && sellerColumn) result = result.filter(row => String(row[sellerColumn]).trim() === selectedSeller);
                if (selectedDevice && deviceColumn) result = result.filter(row => String(row[deviceColumn]).trim() === selectedDevice);
                return result;
            }, [data, selectedSeller, sellerColumn, selectedDevice, deviceColumn]);

            const alertStats = useMemo(() => {
                let stats = { total: 0 };
                dataForStats.forEach(row => { if (getRowAlertStatus(row, headers)) stats.total++; });
                return stats;
            }, [dataForStats, headers, activeConfig]);

            const fpdStats = useMemo(() => {
                const dateCol = findConfigColumn(activeConfig.columns.date, headers);
                if (!dateCol) return { found: false };

                const formatDateShort = (d) => d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                const now = new Date(); now.setHours(0,0,0,0);

                const calculateFPD = (quotaKey) => {
                    if (!activeConfig.quotas.includes(quotaKey)) return null;

                    const qName = QUOTA_LABELS[quotaKey].id;
                    const weeksAgo = QUOTA_LABELS[quotaKey].weeksAgo;

                    const range = getCohortRange(weeksAgo);
                    const cohortSales = dataForStats.filter(row => {
                        const d = parseDate(row[dateCol]);
                        return d && d >= range.start && d <= range.end;
                    });
                    const totalSales = cohortSales.length;
                    if (totalSales === 0) return { totalSales: 0, unpaid: 0, rangeStr: `${formatDateShort(range.start)} - ${formatDateShort(range.end)}` };

                    let obsCol = findColumnName(activeConfig.columns.observation, qName, headers);
                    if (!obsCol && portfolio === 'alocredit' && quotaKey === 'q1') {
                        obsCol = findColumnName(activeConfig.columns.observation, '', headers);
                    }

                    const quotaDateCol = findColumnName(qName, activeConfig.columns.quotaDate, headers);
                    
                    let unpaid = 0;
                    if (obsCol) {
                        unpaid = cohortSales.filter(row => {
                            if (quotaDateCol) {
                                const qDate = parseDate(row[quotaDateCol]);
                                if (qDate && qDate >= now) return false; 
                            }
                            const val = String(row[obsCol] || '').toLowerCase().trim();
                            return isObsUnpaid(val);
                        }).length;
                    }
                    return { totalSales, unpaid, rangeStr: `${formatDateShort(range.start)} - ${formatDateShort(range.end)}` };
                };

                const q1 = calculateFPD('q1');
                const q2 = calculateFPD('q2');
                const q3 = calculateFPD('q3');

                let totalUnpaid = (q1?.unpaid || 0) + (q2?.unpaid || 0) + (q3?.unpaid || 0);
                let totalSales = (q1?.totalSales || 0) + (q2?.totalSales || 0) + (q3?.totalSales || 0);
                
                const generalFPD = totalSales > 0 ? ((totalUnpaid / totalSales) * 100).toFixed(1) : 0;

                return { found: true, colUsed: dateCol, generalFPD, q1, q2, q3 };
            }, [dataForStats, headers, activeConfig, findColumnName, findConfigColumn, portfolio]);

            const observationStats = useMemo(() => {
                const calc = (quotaKey) => {
                    if (!activeConfig.quotas.includes(quotaKey)) return null;
                    const qName = QUOTA_LABELS[quotaKey].id;

                    let s = { conGestion: 0, noCancelo: 0, yaCancelo: 0, vacio: 0 };
                    
                    let col = findColumnName(activeConfig.columns.observation, qName, headers);
                    if (!col && portfolio === 'alocredit' && quotaKey === 'q1') {
                        col = findColumnName(activeConfig.columns.observation, '', headers);
                    }

                    if(!col) return s;
                    filteredData.forEach(row => {
                        const val = String(row[col] || '').toLowerCase().trim();
                        if (!val) s.vacio++;
                        else if (val.includes('no se cancelo cuota')) s.noCancelo++;
                        else if (val.includes('no cancelo') || val.includes('no canceló') || val.includes('no pago')) s.noCancelo++;
                        else if (val.includes('gets solutions pago cuota')) s.conGestion++;
                        else if (val.includes('ya cancelo cuota') || val.includes('con gestion') || val.includes('con gestión')) s.conGestion++;
                        else if (val.includes('ya cancelo') || val.includes('ya canceló') || val.includes('cancelo') || val.includes('pagó') || val.includes('pago')) s.yaCancelo++;
                    });
                    return s;
                }
                return {
                    q1: calc('q1'), q2: calc('q2'), q3: calc('q3'), found: true
                };
            }, [filteredData, headers, findColumnName, activeConfig, portfolio]);

            // --- UI HELPERS ---
            const getColumnStyles = (headerName) => {
                if (!headerName) return null;
                const lowerHeader = String(headerName).toLowerCase().trim();
                if (lowerHeader.includes("primera cuota")) return { head: "bg-blue-100 text-blue-900 border-b-2 border-blue-300", cellBase: "border-l border-r border-blue-100", bgColor: "bg-blue-50/50" };
                if (lowerHeader.includes("segunda cuota")) return { head: "bg-purple-100 text-purple-900 border-b-2 border-purple-300", cellBase: "border-l border-r border-purple-100", bgColor: "bg-purple-50/50" };
                if (lowerHeader.includes("tercera cuota")) return { head: "bg-orange-100 text-orange-900 border-b-2 border-orange-300", cellBase: "border-l border-r border-orange-100", bgColor: "bg-orange-50/50" };
                return null;
            };

            const StatCard = ({ title, stats, quotaId, fpdInfo }) => {
                if (!stats) return null;
                let fpdPercent = "0.0", recoverNeeded = 0, targetPercent = quotaId === 'q1' ? 10 : 20;
                let hasSales = fpdInfo && fpdInfo.totalSales > 0;

                if (hasSales) {
                    fpdPercent = ((fpdInfo.unpaid / fpdInfo.totalSales) * 100).toFixed(1);
                    const maxAllowed = Math.floor((fpdInfo.totalSales * targetPercent) / 100);
                    recoverNeeded = Math.max(0, fpdInfo.unpaid - maxAllowed);
                }
                
                let fpdColor = hasSales 
                    ? (parseFloat(fpdPercent) > 30 ? "text-red-700 bg-red-100" : parseFloat(fpdPercent) > 15 ? "text-yellow-700 bg-yellow-100" : "text-green-700 bg-green-100") 
                    : "text-slate-500 bg-slate-100";
                
                const isFpdActive = fpdQuotaFilter === quotaId;
                const isActive = (t) => breakdownFilter && breakdownFilter.quota === quotaId && breakdownFilter.type === t;
                const baseRow = "flex justify-between items-center p-2 rounded cursor-pointer transition-colors hover:ring-1 hover:ring-indigo-300";

                return (
                    <div className={`p-4 rounded-xl border shadow-sm bg-white border-slate-200`}>
                        <div className="flex items-center gap-2 mb-3 border-b pb-2">
                             <Icons.FileText className="w-4 h-4 text-slate-600" />
                             <h3 className="text-sm font-bold uppercase tracking-wide text-slate-700">{title}</h3>
                        </div>
                        {/* FPD Box */}
                        <div 
                            onClick={() => { if(hasSales) { setFpdQuotaFilter(isFpdActive ? null : quotaId); setBreakdownFilter(null); setShowOnlyAlerts(false); }}}
                            className={`mb-3 p-3 rounded-lg ${fpdColor} border border-white/50 shadow-sm transition-all ${hasSales ? 'cursor-pointer hover:ring-2 hover:ring-indigo-400' : ''} ${isFpdActive ? 'ring-2 ring-indigo-500' : ''}`}
                        >
                            <div className="flex justify-between mb-2">
                                <span className="text-[10px] font-bold uppercase opacity-80 flex items-center gap-1">{isFpdActive && <Icons.Filter className="w-3 h-3 animate-pulse"/>} FPD7 (Sem -{QUOTA_LABELS[quotaId].weeksAgo})</span>
                                <span className="text-xl font-bold">{hasSales ? `${fpdPercent}%` : 'N/A'}</span>
                            </div>
                            {hasSales && fpdInfo ? (
                                <div className="text-[11px] space-y-1 border-t border-black/10 pt-2">
                                    <div className="flex justify-between"><span className="opacity-80">Ventas:</span><span className="font-bold">{fpdInfo.totalSales}</span></div>
                                    <div className={`flex justify-between p-1 -mx-1 rounded ${isFpdActive ? 'bg-white/40 font-bold' : ''}`}>
                                        <span className="opacity-80">No Han Pagado:</span><span className="font-bold underline">{fpdInfo.unpaid}</span>
                                    </div>
                                    <div className="flex justify-between text-red-800 font-bold mt-1 bg-white/30 p-1 rounded -mx-1">
                                        <span className="text-[10px] flex items-center gap-1"><Icons.Target className="w-3 h-3"/> Meta {targetPercent}%:</span><span>{recoverNeeded}</span>
                                    </div>
                                    <div className="text-[9px] text-right opacity-60 pt-1 mt-1 border-t border-black/5">{fpdInfo.rangeStr}</div>
                                </div>
                            ) : <span className="text-[10px] opacity-70">Sin ventas en {fpdInfo ? fpdInfo.rangeStr : 'periodo'}</span>}
                        </div>
                        {/* Contadores */}
                        <div className="space-y-1">
                             <div onClick={() => { setBreakdownFilter({quota: quotaId, type: 'yaCancelo'}); setFpdQuotaFilter(null); }} className={`${baseRow} ${isActive('yaCancelo') ? 'bg-green-100 ring-2 ring-green-500' : 'bg-slate-50'}`}>
                                <span className="text-xs font-bold text-green-700 flex gap-1"><Icons.DollarSign className="w-3 h-3"/> Ya Canceló</span><span className="font-bold">{stats.yaCancelo}</span>
                             </div>
                             <div onClick={() => { setBreakdownFilter({quota: quotaId, type: 'conGestion'}); setFpdQuotaFilter(null); }} className={`${baseRow} ${isActive('conGestion') ? 'bg-blue-100 ring-2 ring-blue-500' : 'bg-slate-50'}`}>
                                <span className="text-xs font-bold text-blue-700 flex gap-1"><Icons.Handshake className="w-3 h-3"/> Con Gestión</span><span className="font-bold">{stats.conGestion}</span>
                             </div>
                             <div onClick={() => { setBreakdownFilter({quota: quotaId, type: 'noCancelo'}); setFpdQuotaFilter(null); }} className={`${baseRow} ${isActive('noCancelo') ? 'bg-red-100 ring-2 ring-red-500' : 'bg-slate-50'}`}>
                                <span className="text-xs font-bold text-red-600 flex gap-1"><Icons.XCircle className="w-3 h-3"/> No Canceló</span><span className="font-bold">{stats.noCancelo}</span>
                             </div>
                             <div onClick={() => { setBreakdownFilter({quota: quotaId, type: 'vacio'}); setFpdQuotaFilter(null); }} className={`${baseRow} ${isActive('vacio') ? 'bg-slate-200 ring-2 ring-slate-500' : 'bg-slate-50'}`}>
                                <span className="text-xs font-bold text-slate-500 flex gap-1"><Icons.HelpCircle className="w-3 h-3"/> Sin dato</span><span className="font-bold">{stats.vacio}</span>
                             </div>
                        </div>
                    </div>
                );
            };

            const headerColorClass = activeConfig.theme === 'indigo' ? 'border-indigo-500' : 'border-blue-500';

            return (
                <div className="max-w-7xl mx-auto p-4 space-y-6">
                    {/* Header */}
                    <div className={`bg-white rounded-xl shadow p-6 border-l-4 ${headerColorClass} flex flex-col md:flex-row justify-between items-center gap-4`}>
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-slate-100 rounded-lg"><Icons.CreditCard className={`w-6 h-6 text-${activeConfig.theme}-600`} /></div>
                            <div>
                                <h1 className="text-2xl font-bold text-slate-900">CARTERA {activeConfig.name}</h1>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className={`inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium ${loading ? 'bg-blue-100 text-blue-700' : data.length > 0 ? 'bg-green-100 text-green-700' : 'bg-slate-100'}`}>
                                        {loading ? 'Cargando...' : `Conectado (${APP_VERSION})`}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div className="flex bg-slate-100 p-1 rounded-lg">
                            <button onClick={() => setPortfolio('alocredit')} className={`px-4 py-2 rounded-md text-sm font-bold ${portfolio === 'alocredit' ? 'bg-indigo-600 text-white shadow' : 'text-slate-600'}`}>ALOCREDIT</button>
                            <button onClick={() => setPortfolio('payjoy')} className={`px-4 py-2 rounded-md text-sm font-bold ${portfolio === 'payjoy' ? 'bg-blue-600 text-white shadow' : 'text-slate-600'}`}>PAYJOY</button>
                            <button onClick={fetchData} className="px-3 text-slate-500"><Icons.RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} /></button>
                        </div>
                    </div>

                    {error && <div className="bg-red-50 p-4 rounded-lg border border-red-200 flex gap-3 text-red-700"><Icons.AlertCircle className="w-5 h-5"/><div><h3 className="font-bold">Error</h3><p>{error}</p></div></div>}

                    {/* Filtros */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div className="bg-white p-4 rounded-xl shadow border border-slate-200">
                            <p className="text-xs font-bold text-slate-500 mb-1">Vendedor</p>
                            <select className="w-full p-2 bg-slate-50 border rounded text-sm" value={selectedSeller} onChange={e => setSelectedSeller(e.target.value)}>
                                <option value="">Todos</option>
                                {sellers.map((s,i) => <option key={i} value={s}>{s}</option>)}
                            </select>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow border border-slate-200">
                            <p className="text-xs font-bold text-slate-500 mb-1">Equipo</p>
                            <select className="w-full p-2 bg-slate-50 border rounded text-sm" value={selectedDevice} onChange={e => setSelectedDevice(e.target.value)}>
                                <option value="">Todos</option>
                                {devices.map((d,i) => <option key={i} value={d}>{d}</option>)}
                            </select>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow border border-slate-200">
                             <p className="text-xs font-bold text-slate-500 mb-1">Buscar</p>
                             <input type="text" className="w-full p-2 bg-slate-50 border rounded text-sm" placeholder="Nombre, cédula..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow border border-slate-200 flex justify-between items-center">
                            <div><p className="text-xs font-bold text-slate-500">Clientes</p><p className="text-2xl font-bold">{filteredData.length}</p></div>
                            <Icons.Users className="w-8 h-8 text-slate-300" />
                        </div>
                    </div>

                    {/* Alertas */}
                    {alertStats.total > 0 && (
                        <div className="bg-red-50 border border-red-200 rounded-xl p-4 flex justify-between items-center">
                             <div className="flex gap-3 items-center">
                                <div className="p-2 bg-red-100 rounded-full text-red-600"><Icons.BellRing className="w-5 h-5"/></div>
                                <div>
                                    <h2 className="text-red-800 font-bold">{alertStats.total} Clientes Prioritarios</h2>
                                    <p className="text-xs text-red-600">Vencidos hace 5-7 días sin gestión.</p>
                                </div>
                             </div>
                             <button onClick={() => setShowOnlyAlerts(!showOnlyAlerts)} className={`px-4 py-2 rounded-lg text-sm font-bold border ${showOnlyAlerts ? 'bg-red-600 text-white' : 'bg-white text-red-600 border-red-200'}`}>
                                {showOnlyAlerts ? 'Ver Todos' : 'Ver Alertas'}
                             </button>
                        </div>
                    )}

                    {/* Dashboard Principal FPD */}
                    <div className="bg-slate-100 p-4 rounded-xl border border-slate-200">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-slate-600 flex gap-2"><Icons.FileText className="w-5 h-5"/> Análisis de Cohortes</h3>
                            { (fpdQuotaFilter || breakdownFilter) && 
                                <button onClick={() => { setFpdQuotaFilter(null); setBreakdownFilter(null); }} className="text-xs bg-slate-800 text-white px-3 py-1 rounded-full flex gap-1 items-center">
                                    <Icons.X className="w-3 h-3"/> Quitar Filtros
                                </button>
                            }
                        </div>
                        
                        <div className="flex justify-center mb-4">
                            {fpdStats.found && (
                                <div className="bg-white px-4 py-2 rounded-full shadow-sm border border-slate-200 flex gap-4 items-center">
                                    <Icons.TrendingDown className="w-5 h-5 text-slate-400"/>
                                    <div className="text-center">
                                        <p className="text-[10px] font-bold text-slate-400 uppercase">Morosidad General</p>
                                        <p className="text-xl font-bold text-slate-700">{fpdStats.totalSalesAll > 0 ? `${fpdStats.generalFPD}%` : 'N/A'}</p>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className={`grid grid-cols-1 md:grid-cols-${activeConfig.quotas.length} gap-4`}>
                            {activeConfig.quotas.includes('q1') && <StatCard title="Obs. Primera Cuota" quotaId="q1" stats={observationStats.q1} fpdInfo={fpdStats.q1} />}
                            {activeConfig.quotas.includes('q2') && <StatCard title="Obs. Segunda Cuota" quotaId="q2" stats={observationStats.q2} fpdInfo={fpdStats.q2} />}
                            {activeConfig.quotas.includes('q3') && <StatCard title="Obs. Tercera Cuota" quotaId="q3" stats={observationStats.q3} fpdInfo={fpdStats.q3} />}
                        </div>
                    </div>

                    {/* Tabla */}
                    <div className="bg-white rounded-xl shadow overflow-hidden border border-slate-200 overflow-x-auto">
                        <table className="w-full text-left text-sm text-slate-600">
                            <thead className="bg-slate-50 font-bold border-b">
                                <tr>{headers.map((h, i) => {
                                    const style = getColumnStyles(h);
                                    // Check if phone column
                                    const isPhoneCol = activeConfig.columns.phone && activeConfig.columns.phone.some(p => h.toLowerCase().includes(p));
                                    return <th key={i} className={`px-4 py-3 whitespace-nowrap ${style?.head} ${isPhoneCol ? 'min-w-[140px]' : ''}`}>{h}</th>
                                })}</tr>
                            </thead>
                            <tbody className="divide-y">
                                {filteredData.map((row, i) => (
                                    <tr key={i} className="hover:bg-indigo-50">
                                        {headers.map((h, j) => {
                                            const val = formatCellData(row[h]);
                                            const style = getColumnStyles(h);
                                            let isAlert = false;
                                            
                                            // Alerta
                                            if (style) {
                                                let qName = '';
                                                if (h.toLowerCase().includes('primera')) qName='primera';
                                                else if (h.toLowerCase().includes('segunda')) qName='segunda';
                                                else if (h.toLowerCase().includes('tercera')) qName='tercera';
                                                
                                                let qKey = qName === 'primera' ? 'q1' : qName === 'segunda' ? 'q2' : 'q3';

                                                if(qName && activeConfig.quotas.includes(qKey) && checkSpecificQuotaAlert(row, headers, qName)) isAlert = true;
                                            }

                                            // Render Celular
                                            const isPhoneCol = activeConfig.columns.phone && activeConfig.columns.phone.some(p => h.toLowerCase().includes(p));
                                            if (isPhoneCol) {
                                                // CAPTURA DEL NOMBRE PARA EL MENSAJE
                                                const clientVal = clientColumn ? row[clientColumn] : '';
                                                // CAPTURA DEL EQUIPO (NUEVO)
                                                const deviceVal = deviceColumn ? row[deviceColumn] : '';
                                                
                                                const clean = cleanPhoneNumber(val);
                                                if (clean) {
                                                    return (
                                                        <td key={j} className="px-4 py-3 whitespace-nowrap flex items-center gap-2">
                                                            <span className="font-mono text-xs">{val}</span>
                                                            <a 
                                                                href={getWhatsAppLink(val, clientVal, deviceVal)} 
                                                                target="_blank" 
                                                                className="p-1.5 bg-green-100 text-green-600 rounded-md hover:bg-green-200 transition-colors"
                                                                title="Enviar WhatsApp"
                                                            >
                                                                <Icons.MessageCircle className="w-4 h-4" />
                                                            </a>
                                                            <a 
                                                                href={`tel:${clean}`}
                                                                className="p-1.5 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200 transition-colors"
                                                                title="Llamar"
                                                            >
                                                                <Icons.Phone className="w-4 h-4" />
                                                            </a>
                                                        </td>
                                                    );
                                                }
                                            }

                                            return (
                                                <td key={j} className={`px-4 py-3 whitespace-nowrap ${style?.bgColor} ${isAlert ? 'bg-red-500 text-white font-bold' : ''}`}>
                                                    {isAlert && <Icons.AlertTriangle className="w-3 h-3 inline mr-1 text-white"/>}
                                                    {val}
                                                </td>
                                            )
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
